name: 'Build and push to S3'

# **What it does**: Converts README to docx and pushes to S3.
# **Why we have it**: Recruiters want files and not links to Github.
# **Who does it impact**: My career.

on: [push]

permissions:
  id-token: write # This is required for AWS OIDC
  contents: read

jobs:
  convert:
    runs-on: [self-hosted]
    steps:

      - name: Checkout
        uses: actions/checkout@v3

      - name: Convert docs
        run: ./pandoc.sh

      - name: Upload output files
        uses: actions/upload-artifact@v3
        with:
          name: converted-files
          path: SimonStaszkiewiczResume.*

  push:
    runs-on: [self-hosted]
    needs: convert
    steps:

      - name: configure aws credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: arn:aws:iam::444794566584:role/GithubActionsS3Push
          role-session-name: github-resume-job
          aws-region: us-west-2

      - name: Download output files
        uses: actions/download-artifact@v3
        with:
          name: converted-files

      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup node
        uses: actions/setup-node@v3
        with:
          node-version: 18.x
          cache: npm

      - name: Install
        run: npm ci

      - name: Push files to s3
        run: ./push.sh
